name: Build Codev App APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: üß∞ Install Buildozer and dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            zip unzip openjdk-11-jdk zlib1g-dev \
            python3-pip python3-setuptools git \
            libncurses5 libstdc++6 libffi-dev libssl-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
            libfreetype6-dev libgstreamer1.0-dev \
            gstreamer1.0-plugins-base gstreamer1.0-plugins-good

          python3 -m pip install --upgrade pip setuptools
          pip install buildozer cython

      # This is the new step to accept Android SDK licenses
      - name: ‚úÖ Accept Android SDK licenses
        run: |
          # Set Android SDK Root environment variable
          export ANDROID_SDK_ROOT=${HOME}/.buildozer/android/platform/android-sdk
          # Create necessary directories if they don't exist
          mkdir -p ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin
          # Download command-line tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-8583075_latest.zip -O /tmp/commandlinetools.zip
          unzip -q /tmp/commandlinetools.zip -d ${ANDROID_SDK_ROOT}/cmdline-tools/latest
          # Accept licenses
          yes | ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --licenses

      - name: üèóÔ∏è Build APK
        run: |
          buildozer android debug

      - name: ‚¨ÜÔ∏è Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: codev-debug-apk
          path: bin/*.apk
